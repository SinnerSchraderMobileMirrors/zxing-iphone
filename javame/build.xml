<?xml version="1.0" encoding="UTF-8"?>
<project name="javame" default="build">

  <property file="../build.properties"/>

  <path id="wtk-build-path">
    <fileset dir="${WTK-home}/lib">
      <include name="cldcapi11.jar"/>
      <include name="midpapi20.jar"/>
      <include name="mmapi.jar"/>
      <include name="jsr234.jar"/>
      <include name="satsa-apdu.jar"/>
    </fileset>
    <pathelement location="../core/core.jar"/>
  </path>

  <target name="init">
    <tstamp/>
  </target>

  <target name="build" depends="init">

    <fail message="Please set 'JDK1.4-classes' in build.properties">
      <condition>
        <not>
          <available file="${JDK1.4-classes}" type="file"/>
        </not>
      </condition>
    </fail>
    <fail message="Please set 'WTK-home' in build.properties">
      <condition>
        <not>
          <available file="${WTK-home}" type="dir"/>
        </not>
      </condition>
    </fail>

    <mkdir dir="build"/>
    <javac srcdir="src"
           destdir="build"
           source="1.4"
           target="1.4"
           bootclasspath="${JDK1.4-classes}"
           optimize="true"
           debug="true"
           deprecation="true"
           fork="true">
           <classpath refid="wtk-build-path"/>
    </javac>

    <unzip src="../core/core.jar" dest="build"/>

    <mkdir dir="build-j2me"/>
    <property name="preverify-classpath" refid="wtk-build-path"/>
    <exec executable="${WTK-home}/bin/preverify1.1">
      <arg line="-classpath ${preverify-classpath} -d build-j2me build"/>
    </exec>

    <copy todir="build-j2me">
      <fileset dir=".">
        <include name="res/**"/>
      </fileset>
    </copy>

    <jar jarfile="ZXingReader.jar" basedir="build-j2me" manifest="src/com/google/zxing/client/j2me/MANIFEST.MF"/>

    <!-- get .jar size to include it in the .jad file -->
    <length file="ZXingReader.jar" property="jar-size"/>
    
    <copy file="ZXingReader.jad.template" tofile="ZXingReader.jad" overwrite="true">
      <filterset>
        <filter token="JAR_SIZE" value="${jar-size}"/>
      </filterset>
    </copy>

  </target>

  <target name="clean">
    <delete dir="build"/>
    <delete dir="build-j2me"/>
    <delete file="ZXingReader.jar"/>
    <delete file="ZXingReader.jad"/>    
  </target>

</project>
